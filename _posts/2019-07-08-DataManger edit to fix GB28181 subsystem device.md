---
layout: post
title: GB28181网关适配TF平台
date: '2019-07-08 14:41'
categories: 
 - 工作记录
tags:
 - 数据库
 - GB28181
---

# 说明

在目前的设计中，只对GB28181网关直接管理的设备能完美使用各项功能（目前缺少联动报警相关的），但是对接入网关的子系统的设备则无法完美使用各项功能。
目前缺少以下功能：
1. 设备OSD显示【修改表+修改GB28181Controller处理流程】
2. 无法添加录像计划【修改GB28181Controller处理流程】
3. 无法获取录像【修改GB28181Controller处理流程】
4. 无法对录像切片【修改GB28181Controller处理流程】
5. 无法添加到地图【修改客户端地图位置操作和GB28181Controller处理的流程】
6. 添加设备操作日志【修改GB28181Controller处理流程】
7. 日志查询【将网关的所有设备都归入本级域内】

GB28181缺少：
1. 实时事件图片显示 【网关将警报信息通过消息队列传到客户端】
2. 事件联动【较为复杂，建议另启一个任务】
3. 添加设备事件日志【网关直接将警报信息通过HTTP请求发送到中心服务】

# 设计

## 数据库设计

在`tf-system-service`中的`DataManager`类中添加数据库修改语句：
删除`device_osd`表中的`device_guid`的关联。
删除`event_record`表中的`device_guid`的关联。
删除`nvr_chan_postion`表中的`device_guid`的关联。
在删除设备时同时将`device_osd`和`nvr_chan_postion`中相关信息删除，不删除`event_record`中的相关信息。

## 中心服务设计

客户端对于GB28181的子系统的HTTP请求不做特别的处理，还是当作由中心服务转发给下级的这种方式。但是在中心服务，要对请求的域做出解析和分类。
当发现下一级域就是GB28181子系统时，就将请求交给`GB28181Controller`去处理。
类似录像计划、录像相关的就直接转发给网关存储服务处理。而日志、osd，地图相关的就直接在中心服务完成处理。

## 客户端设计

日志查询中在域的Combobox中不显示GB28181子系统，并且在选择域的时候将该域中包含的GB28181子系统的设备都加入到设备的Combobox。
在地图中，在处理GB28181子系统设备时，使用对NVR操作的流程来处理。

# 完成后发现的几个问题

1. 要取消`map_guid`的关联，这样在将下级设备添加到本级的本地地图时就不会出现无法添加的情况了。
2. 无法查看到GB28181子系统设备的录像计划状态（设备图标没有变成蓝色）。

