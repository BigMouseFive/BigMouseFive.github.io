{"compress":true,"commitItems":[["29e6a120-ea88-45a9-9f3d-05f8c2d1ef46",1552806685625,"---\nlayout: post\ntitle: fbs改价策略\ndate: '2019-03-13 20:53'\ncategories: \n - 工作记录\n - 自动改价程序\ntags:\n---\n# 改价策略\n\n* 情况分析：\n  * 当**购物车价格**小于**当前定价**，**降价比**不超过**设定值**，设置价格为【**购物车价格**-**降价值**】\n  * 当**购物车价格**小于**当前定价**，**降价比**超过**设定值**，不改价\n  * 当**购物车价格**等于**当前定价**，不改价\n  * 当**购物车价格**大于**当前定价**，不改价\n\n\n# 改价程序流程\n\n* 启动chrome浏览器 \n\n```python\nchrome=webdriver.Chrome(executable_path=chromePath, chrome_options=option)\n```\n\n* 打开卖家登录界面[seller-login](https://uae.souq.com/ae-en/account.php)\n\n```\n# 获取email 和 password 控件\n    print(\"登录账户\")\n    chrome.get(loginUri)\n    try:\n        elemNewAccount = chrome.find_element_by_id(\"email\")\n        elemNewLoginBtn = chrome.find_element_by_id(\"siteLogin\")\n        elemNewAccount.send_keys(account)\n        print(\"输入账户:\" + account)\n        elemNewLoginBtn.click()\n        print(\"点击siteLogin\")\n        try:\n            cssSelectText = \"#continue\"\n            WebDriverWait(chrome, 10, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n            print(\"获取到continue按钮\")\n            elemContinue = chrome.find_element_by_id(\"continue\")\n            elemContinue.click()\n            print(\"点击continue\")\n            cssSelectText = \"#ap_password\"\n            WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n            print(\"获取到password输入框\")\n            elemPassword = chrome.find_element_by_id(\"ap_password\")\n            elemLoginBtn = chrome.find_element_by_id(\"signInSubmit\")\n            elemPassword.send_keys(Keys.CONTROL + \"a\")\n            elemPassword.send_keys(password)\n            print(\"输入密码：********\")\n            elemLoginBtn.click()\n            print(\"点击continue\")\n        except:\n            print(\"方式一登录失败，尝试方式二登录\")\n            cssSelectText = \"#password\"\n            WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n            print(\"获取到password输入框\")\n            elemPassword = chrome.find_element_by_id(\"password\")\n            elemLoginBtn = chrome.find_element_by_id(\"siteLogin\")\n            elemPassword.clear()\n            elemPassword.send_keys(password)\n            print(\"输入密码：********\")\n            elemLoginBtn.click()\n            print(\"点击登录\")\n\n        cssSelectText = \"#search_box\"\n        WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n    except:\n        if str(chrome.current_url).find(\"uae.souq.com/ae-en/account.php\") < 0:\n            raise\n```\n\n* 登入成功后打开[fbs-inventory](https://sell.souq.com/fbs-inventory)\n\n```\nloginHandler = chrome.current_window_handle\n    handlers = chrome.window_handles\n    unknownHandler = \"\"\n    for handler in handlers:\n        if handler != loginHandler:\n            unknownHandler = handler\n            break\n    readyUri = \"https://sell.souq.com/fbs-inventory\"\n    js = 'window.open(\"' + readyUri + '\")'\n    chrome.execute_script(js)\n    handlers = chrome.window_handles\n    for handler in handlers:\n        if handler != loginHandler and handler != unknownHandler:\n            inventoryHandler = handler\n            break\n    print(\"跳转到改价界面\")\n    while 1:\n        try:\n            chrome.switch_to_window(inventoryHandler)\n            print(\"开始循环处理\")\n            OperateProduct(chrome, record, attention, percent, lowwer)\n        except:\n            print(\"循环改价发生错误，马上重新开始\")\n        print(\"刷新改价界面\")\n        chrome.refresh()\n```\n\n* 开始循环改价\n  * 获取商品列表的第一行 **first_row**\n\n```python\n first_row = chrome.find_elements_by_css_selector('//*[@id=\"table-inventory\"]/tbody/tr[1]')\n```\n\n  * 点击第一行 \n  \n```python\nchrome.execute_script(\"arguments[0].click()\", first_row)\n```\n\n  * 循环改价操作\n   \n![chagePriceOperate](/styles/images/chagePriceOperate.png)\n\n```python\n    i = 0\n    while 1:\n        WebDriverWait(chrome, 60, 0.5).until(checkPage)\n        gold_price = 0\n\n        # 获取EAN\n        ean_elem = chrome.find_element_by_xpath('//*[@id=\"offerListitng\"]/div[2]/div/div[1]/div[1]/span')\n        ean = ean_elem.text.split(\";\")[-1]\n        timestr = time.strftime(\"%Y-%m-%d %H:%M:%S\")\n\n        # 获取当前价格输入框，并获取当前价格\n        self_price_elem = chrome.find_element_by_xpath(\n            '//*[@id=\"offerListitng\"]/div[4]/div[2]/div/div/div/div[1]/sc-offer-listing/div/div[1]/label[2]/input')\n        self_price = float(self_price_elem.get_attribute(\"value\"))\n\n        # 获取购物车价格\n        try:\n            gold_price_elem = chrome.find_element_by_xpath('//*[@id=\"offerListitng\"]/div[4]/div[2]/div/div/div/div[1]/sc-offer-listing/div/div[1]/label[2]/small[1]/span[2]')\n            gold_price = float(re.findall(r\"\\d+\\.?\\d*\", gold_price_elem.text)[0])\n        except NoSuchElementException:\n            i += 1\n            out = str(i) + \"-->\" + timestr + \" \" + ean + \"\\t只有本店铺一家卖此产品\"\n            print(out)\n        out = timestr + \" \" + ean + \"\\t购物车：\" + str(gold_price) + \"\\t本店铺：\" + str(self_price) + \"\\t降价比:\" + str(\n            round((self_price - gold_price) / self_price, 2) * 100) + \"%\"\n\n        # 判断\n        # if 购物车价格 小于 当前定价 and 降价比 不超过 设定值:\n        if gold_price < self_price and ((self_price-gold_price)/self_price) <= percent:\n            # 修改当前价格输入框的中价格为【购物车价格-降价值】\n            to_price = round(gold_price - lowwer, 2)\n            self_price_elem.send_keys(Keys.CONTROL + \"a\")\n            self_price_elem.send_keys(str(to_price))\n            # 获取按钮【更新】，并点击\n            update_elem = chrome.find_element_by_xpath('//*[@id=\"offerListitng\"]/div[3]/div/div/input')\n            chrome.execute_script(\"arguments[0].click()\", update_elem)\n            out += \"\\t修改价格：\" + str(to_price) + \"\\n\"\n            record.write(out)\n            record.flush()\n        else:\n            out += \"\\t不处理\\n\"\n            attention.write(out)\n            attention.flush()\n        out = out[0:-1]\n        i += 1\n        out = str(i) + \"-->\" + out\n        print(out)\n        # 获取按钮【下一个】，并点击\n        path = '//*[@id=\"offerListitng\"]/div[3]/div/div/div/div/div/a[2]'\n        WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.XPATH, path)))\n        next_elem = chrome.find_element_by_xpath(path)\n        if next_elem.get_attribute(\"class\") == \"button-disabled\":\n            print(\"完成一次循环\")\n            raise IndexError\n        chrome.execute_script(\"arguments[0].click()\", next_elem)\n        time.sleep(0.5)\n```\n\n# 总结\n\n* xpath的使用\n* 判断网页已全部加载完成\n\n```\ndef checkPage(driver):\n    checkPageFinishScript = \"try {if (document.readyState !== 'complete') {return false;} if (window.jQuery) { if (\" \\\n                            \"window.jQuery.active) { return false; } else if (window.jQuery.ajax && \" \\\n                            \"window.jQuery.ajax.active) { return false; } } if (window.angular) { if (!window.qa) { \" \\\n                            \"window.qa = {doneRendering: false }; } var injector = window.angular.element(\" \\\n                            \"'body').injector(); var $rootScope = injector.get('$rootScope'); var $http = \" \\\n                            \"injector.get('$http'); var $timeout = injector.get('$timeout'); if ($rootScope.$$phase \" \\\n                            \"=== '$apply' || $rootScope.$$phase === '$digest' || $http.pendingRequests.length !== 0) \" \\\n                            \"{ window.qa.doneRendering = false; return false; } if (!window.qa.doneRendering) { \" \\\n                            \"$timeout(function() { window.qa.doneRendering = true;}, 0); return false;}} return \" \\\n                            \"true;} catch (ex) {return false;} \"\n    return driver.execute_script(checkPageFinishScript)\n\nWebDriverWait(chrome, 60, 0.5).until(checkPage)\n```\n\n* 请空**INPUT框**的内容\n\n```python\n# 方法一：使用clear清空\ninput_elem.clear()\ninput_elem.send_keys(\"content\")\n# 方法二:\ninput_elem.send_keys(Keys.CONTROL + \"a\")\ninput_elem.send_keys(\"content\")\n```\n\n* python+selenium开发基本过程   \n",[[1552806631082,["79054@DESKTOP-05FPSNP",[[-1,98,"# "]],[99,99],[98,98]]],[1552806632223,["79054@DESKTOP-05FPSNP",[[1,104,"\n"]],[102,102],[103,103]]],[1552806632941,["79054@DESKTOP-05FPSNP",[[1,103,"="]],[103,103],[104,104]]],[1552806634042,["79054@DESKTOP-05FPSNP",[[-1,105,"\n"]],[104,104],[104,104]]],[1552806636476,["79054@DESKTOP-05FPSNP",[[-1,287,"# "]],[287,289],[287,287]]],[1552806638123,["79054@DESKTOP-05FPSNP",[[1,294,"="]],[294,294],[295,295]]],[1552806645582,["79054@DESKTOP-05FPSNP",[[-1,6255,"# "]],[6257,6257],[6255,6255]]],[1552806647230,["79054@DESKTOP-05FPSNP",[[1,6258,"="]],[6258,6258],[6259,6259]]],[1552806688463,["79054@DESKTOP-05FPSNP",[[-1,6258,"="]],[6259,6259],[6258,6258]]],[1552806688967,["79054@DESKTOP-05FPSNP",[[1,6255,"# "]],[6255,6255],[6257,6257]]],[1552806689037,["79054@DESKTOP-05FPSNP",[[-1,294,"="]],[295,295],[294,294]]],[1552806689136,["79054@DESKTOP-05FPSNP",[[1,287,"# "]],[287,287],[287,289]]],[1552806689210,["79054@DESKTOP-05FPSNP",[[1,105,"\n"]],[104,104],[104,104]]],[1552806689336,["79054@DESKTOP-05FPSNP",[[-1,103,"="]],[104,104],[103,103]]],[1552806689421,["79054@DESKTOP-05FPSNP",[[-1,104,"\n"]],[103,103],[102,102]]],[1552806689500,["79054@DESKTOP-05FPSNP",[[1,98,"# "]],[98,98],[99,99]]],[1552807469758,["79054@DESKTOP-05FPSNP",[[1,98,"\n"]],[98,98],[99,99]]],[1552807471805,["79054@DESKTOP-05FPSNP",[[1,99,"@toc\n\n"]],[98,98],[105,105]]],[1552807588565,["79054@DESKTOP-05FPSNP",[[-1,294,"\n"]],[294,294],[293,293]]],[1552807593995,["79054@DESKTOP-05FPSNP",[[-1,304,"* "]],[304,305],[304,304]]],[1552807595595,["79054@DESKTOP-05FPSNP",[[-1,303,"\n"]],[304,304],[303,303]]],[1552807597710,["79054@DESKTOP-05FPSNP",[[1,303,"\n"]],[303,303],[304,304]]],[1552807604334,["79054@DESKTOP-05FPSNP",[[-1,315," "]],[316,316],[315,315]]],[1552807610301,["79054@DESKTOP-05FPSNP",[[-1,407,"* "]],[409,409],[407,407]]],[1552807621701,["79054@DESKTOP-05FPSNP",[[1,474,"pyt"]],[474,474],[477,477]]],[1552807621923,["79054@DESKTOP-05FPSNP",[[-1,476,"t"]],[477,477],[476,476]]],[1552807623076,["79054@DESKTOP-05FPSNP",[[1,476,"thon"]],[476,476],[480,480]]],[1552807629240,["79054@DESKTOP-05FPSNP",[[1,2491,"python"]],[2491,2491],[2497,2497]]],[1552807631577,["79054@DESKTOP-05FPSNP",[[-1,2491,"python"]],[2491,2497],[2491,2491]]],[1552807634817,["79054@DESKTOP-05FPSNP",[[1,2559,"python"]],[2559,2559],[2565,2565]]],[1552807642339,["79054@DESKTOP-05FPSNP",[[1,6305,"python"]],[6305,6305],[6311,6311]]],[1552807660192,["79054@DESKTOP-05FPSNP",[[-1,2493,"* "]],[2495,2495],[2493,2493]]],[1552807662955,["79054@DESKTOP-05FPSNP",[[-1,3411,"* "]],[3413,3413],[3411,3411]]],[1552807672886,["79054@DESKTOP-05FPSNP",[[1,3419,"\n  "]],[3419,3419],[3422,3422]]],[1552807675731,["79054@DESKTOP-05FPSNP",[[-1,3421,"  "]],[3422,3422],[3420,3420]]],[1552807676189,["79054@DESKTOP-05FPSNP",[[-1,3419,"\n"]],[3420,3420],[3419,3419]]],[1552807677789,["79054@DESKTOP-05FPSNP",[[-1,3419," "]],[3419,3419],[3418,3418]]],[1552807678377,["79054@DESKTOP-05FPSNP",[[-1,3418," "]],[3418,3418],[3418,3418]]],[1552807684775,["79054@DESKTOP-05FPSNP",[[-1,3417,"\n"]],[3418,3418],[3417,3417]]],[1552807686053,["79054@DESKTOP-05FPSNP",[[1,3417,"\n"]],[3417,3417],[3418,3418]]],[1552807686977,["79054@DESKTOP-05FPSNP",[[1,3418,"\n"]],[3418,3418],[3419,3419]]],[1552807690599,["79054@DESKTOP-05FPSNP",[[-1,3554,"  "]],[3554,3556],[3554,3554]]],[1552807692471,["79054@DESKTOP-05FPSNP",[[-1,3553,"\n"]],[3554,3554],[3553,3553]]],[1552807694374,["79054@DESKTOP-05FPSNP",[[1,3553,"\n"]],[3553,3553],[3554,3554]]],[1552807705172,["79054@DESKTOP-05FPSNP",[[-1,3561," "]],[3562,3562],[3561,3561]]],[1552807713176,["79054@DESKTOP-05FPSNP",[[-1,3562,"  "]],[3564,3564],[3562,3562]]],[1552807713593,["79054@DESKTOP-05FPSNP",[[-1,3562,"\n"]],[3562,3562],[3561,3561]]],[1552807716177,["79054@DESKTOP-05FPSNP",[[1,3562,"* \n"]],[3561,3561],[3564,3564]]],[1552807717777,["79054@DESKTOP-05FPSNP",[[-1,3562,"* "]],[3564,3564],[3562,3562]]],[1552807722680,["79054@DESKTOP-05FPSNP",[[-1,3635,"  "]],[3635,3637],[3635,3635]]],[1552807723523,["79054@DESKTOP-05FPSNP",[[-1,3642,"作"]],[3643,3643],[3642,3642]]],[1552807725064,["79054@DESKTOP-05FPSNP",[[1,3642,"作"]],[3642,3642],[3643,3643]]],[1552807726729,["79054@DESKTOP-05FPSNP",[[-1,3647,"\n"]],[3647,3647],[3647,3647]]],[1552807747541,["79054@DESKTOP-05FPSNP",[[1,3668,"{}"]],[3668,3668],[3670,3670]]],[1552807748587,["79054@DESKTOP-05FPSNP",[[1,3669,"{"]],[3669,3669],[3670,3670]]],[1552807748680,["79054@DESKTOP-05FPSNP",[[1,3671,"}"]],[3670,3670],[3671,3671]]],[1552807750212,["79054@DESKTOP-05FPSNP",[[1,3670,"size"]],[3670,3670],[3674,3674]]],[1552807750799,["79054@DESKTOP-05FPSNP",[[-1,3672,"ze"]],[3674,3674],[3672,3672]]],[1552807755972,["79054@DESKTOP-05FPSNP",[[1,3672,"te.url/"]],[3672,3672],[3679,3679]]],[1552807760666,["79054@DESKTOP-05FPSNP",[[-1,3675,"url/"]],[3679,3679],[3675,3675]]],[1552807770309,["79054@DESKTOP-05FPSNP",[[1,3675,"baseurl"]],[3675,3675],[3682,3682]]],[1552807770765,["79054@DESKTOP-05FPSNP",[[-1,3681,"l"]],[3682,3682],[3681,3681]]],[1552807771883,["79054@DESKTOP-05FPSNP",[[-1,3673,"e.baseur"]],[3681,3681],[3673,3673]]],[1552807776580,["79054@DESKTOP-05FPSNP",[[1,3673,"e.url | pr"]],[3673,3673],[3683,3683]]],[1552807777592,["79054@DESKTOP-05FPSNP",[[-1,3681,"pr"]],[3683,3683],[3681,3681]]],[1552807780394,["79054@DESKTOP-05FPSNP",[[1,3681,"append siz"]],[3681,3681],[3691,3691]]],[1552807781662,["79054@DESKTOP-05FPSNP",[[-1,3688,"siz"]],[3691,3691],[3688,3688]]],[1552807789953,["79054@DESKTOP-05FPSNP",[[1,3688,"site.baseurl\""]],[3688,3688],[3701,3701]]],[1552807790011,["79054@DESKTOP-05FPSNP",[[-1,3700,"\""],[1,3701,"“"]],[3701,3701],[3701,3701]]],[1552807791510,["79054@DESKTOP-05FPSNP",[[1,3701,"="]],[3701,3701],[3702,3702]]],[1552807793335,["79054@DESKTOP-05FPSNP",[[-1,3700,"“="]],[3702,3702],[3700,3700]]],[1552807794846,["79054@DESKTOP-05FPSNP",[[1,3702,"\""]],[3702,3702],[3703,3703]]],[1552807794891,["79054@DESKTOP-05FPSNP",[[-1,3702,"\""],[1,3703,"“"]],[3703,3703],[3703,3703]]],[1552807797724,["79054@DESKTOP-05FPSNP",[[1,3668,"\""]],[3668,3668],[3669,3669]]],[1552807797768,["79054@DESKTOP-05FPSNP",[[-1,3668,"\""],[1,3669,"“"]],[3669,3669],[3669,3669]]],[1552807807406,["79054@DESKTOP-05FPSNP",[[-1,3668,"“"]],[3669,3669],[3668,3668]]],[1552807808492,["79054@DESKTOP-05FPSNP",[[-1,3702,"“"]],[3703,3703],[3702,3702]]],[1552807829193,["79054@DESKTOP-05FPSNP",[[-1,6297,"* "]],[6297,6299],[6297,6297]]],[1552807830589,["79054@DESKTOP-05FPSNP",[[-1,6306,"* "]],[6306,6308],[6306,6306]]],[1552807833823,["79054@DESKTOP-05FPSNP",[[-1,7563,"* "]],[7563,7565],[7563,7563]]],[1552807836310,["79054@DESKTOP-05FPSNP",[[-1,7742,"* "]],[7742,7744],[7742,7742]]],[1552807840894,["79054@DESKTOP-05FPSNP",[[-1,7763,"   "]],[7765,7766],[7763,7763]]],[1552807957411,["79054@DESKTOP-05FPSNP",[[1,3687,"L"]],[3687,3687],[3688,3688]]],[1552807957907,["79054@DESKTOP-05FPSNP",[[-1,3687,"L"]],[3688,3688],[3687,3687]]],[1552807958182,["79054@DESKTOP-05FPSNP",[[1,3687,":"]],[3687,3687],[3688,3688]]],[1552807986442,["79054@DESKTOP-05FPSNP",[[1,94,"\n"]],[93,93],[94,94]]],[1552807989152,["79054@DESKTOP-05FPSNP",[[1,94," - gaijai "]],[94,94],[104,104]]],[1552807990340,["79054@DESKTOP-05FPSNP",[[-1,97,"gaijai "]],[104,104],[97,97]]],[1552807992964,["79054@DESKTOP-05FPSNP",[[1,97,"改价册率"]],[97,97],[101,101]]],[1552807993699,["79054@DESKTOP-05FPSNP",[[-1,97,"改价册率"]],[101,101],[97,97]]],[1552807994891,["79054@DESKTOP-05FPSNP",[[1,97," "]],[97,97],[98,98]]],[1552808006683,["79054@DESKTOP-05FPSNP",[[-1,78," - 自动改价程序"]],[78,87],[78,78]]],[1552808007895,["79054@DESKTOP-05FPSNP",[[-1,88," "],[1,89,"自动改价程序"]],[85,89],[94,94]]],[1552808010103,["79054@DESKTOP-05FPSNP",[[-1,78,"\n"]],[78,78],[77,77]]],[1552809930584,[null,[[1,3704,"a"],[1,3705,"se"],[-1,3706,"yle"],[-1,3713,"a"],[-1,3715,"es"]],[3704,3704],[3715,3715]]],[1552809930584,[null,[[-1,3704,"a"],[-1,3706,"se"],[1,3709,"yle"],[1,3713,"a"],[1,3714,"es"]],[3715,3715],[3704,3704]]],[1552809894782,["79054@DESKTOP-05FPSNP",[[-1,113,"* "]],[115,115],[113,113]]],[1552809895577,["79054@DESKTOP-05FPSNP",[[-1,122," "]],[123,123],[122,122]]],[1552809896984,["79054@DESKTOP-05FPSNP",[[1,122,"  "]],[122,122],[124,124]]],[1552809898839,["79054@DESKTOP-05FPSNP",[[1,121,"、"]],[121,121],[122,122]]],[1552809900836,["79054@DESKTOP-05FPSNP",[[-1,119,"  、"]],[122,122],[119,119]]],[1552809902300,["79054@DESKTOP-05FPSNP",[[-1,186,"  "]],[188,188],[186,186]]],[1552809903580,["79054@DESKTOP-05FPSNP",[[-1,230,"  "]],[232,232],[230,230]]],[1552809904618,["79054@DESKTOP-05FPSNP",[[-1,257,"  "]],[259,259],[257,257]]],[1552809905952,["79054@DESKTOP-05FPSNP",[[1,119,"\n"]],[119,119],[120,120]]],[1552809907361,["79054@DESKTOP-05FPSNP",[[-1,119,"\n"]],[120,120],[119,119]]],[1552809909497,["79054@DESKTOP-05FPSNP",[[-1,184,"】"]],[185,185],[184,184]]],[1552809911478,["79054@DESKTOP-05FPSNP",[[1,184,"】"]],[184,184],[185,185]]],[1552809917832,["79054@DESKTOP-05FPSNP",[[1,119," "]],[119,119],[120,120]]],[1552809919778,["79054@DESKTOP-05FPSNP",[[1,187," "]],[187,187],[188,188]]],[1552809920734,["79054@DESKTOP-05FPSNP",[[1,232," "]],[232,232],[233,233]]],[1552809921222,["79054@DESKTOP-05FPSNP",[[1,260," "]],[260,260],[261,261]]],[1552809928682,["79054@DESKTOP-05FPSNP",[[1,120,"\n "]],[120,120],[122,122]]],[1552809935892,["79054@DESKTOP-05FPSNP",[[-1,119," "]],[120,120],[119,119]]],[1552809938839,["79054@DESKTOP-05FPSNP",[[-1,120," "]],[121,121],[120,120]]],[1552809940839,["79054@DESKTOP-05FPSNP",[[-1,187," "]],[188,188],[187,187]]],[1552809941471,["79054@DESKTOP-05FPSNP",[[-1,231," "]],[232,232],[231,231]]],[1552809941948,["79054@DESKTOP-05FPSNP",[[-1,258," "]],[259,259],[258,258]]],[1552809944004,["79054@DESKTOP-05FPSNP",[[-1,119,"\n"]],[120,120],[119,119]]],[1552809945287,["79054@DESKTOP-05FPSNP",[[1,119,"\n"]],[119,119],[120,120]]],[1552809986041,["79054@DESKTOP-05FPSNP",[[-1,122," "]],[123,123],[122,122]]],[1552812366549,["79054@DESKTOP-05FPSNP",[[-1,99,"@"],[1,100,"* TOC {:"],[1,103,"}"]],[99,103],[111,111]]],[1552812370487,["79054@DESKTOP-05FPSNP",[[1,104,"\n"]],[104,104],[105,105]]],[1552812371612,["79054@DESKTOP-05FPSNP",[[-1,105," "]],[105,105],[105,105]]],[1552812377286,["79054@DESKTOP-05FPSNP",[[-1,100," "]],[101,101],[100,100]]],[1552812385929,["79054@DESKTOP-05FPSNP",[[-1,98,"\n"],[1,100," "],[-1,103,"\n"],[1,104," "]],[98,110],[110,110]]],[1552812394558,["79054@DESKTOP-05FPSNP",[[-1,103," "]],[104,104],[103,103]]],[1552812394741,["79054@DESKTOP-05FPSNP",[[1,103,"\n"]],[103,103],[104,104]]],[1552812415926,["79054@DESKTOP-05FPSNP",[[-1,99," "]],[100,100],[99,99]]],[1552813674597,["79054@DESKTOP-05FPSNP",[[1,99," "]],[98,109],[110,110]]],[1552829986103,["79054@DESKTOP-05FPSNP",[[-1,98,"* TOC\n{:toc}"],[1,110,"\\"]],[98,110],[99,99]]],[1552829986697,["79054@DESKTOP-05FPSNP",[[1,99,"\\"]],[99,99],[100,100]]],[1552829987395,["79054@DESKTOP-05FPSNP",[[-1,98,"\\\\"]],[100,100],[98,98]]],[1552829987764,["79054@DESKTOP-05FPSNP",[[-1,99,"\n"]],[98,98],[97,97]]],[1552830703812,["79054@DESKTOP-05FPSNP",[[1,107,"## "]],[107,107],[110,110]]],[1552830716271,["79054@DESKTOP-05FPSNP",[[1,292,"## "]],[292,292],[295,295]]],[1552830717667,["79054@DESKTOP-05FPSNP",[[1,398,"## "]],[398,398],[401,401]]],[1552830722831,["79054@DESKTOP-05FPSNP",[[1,2487,"## "]],[2487,2487],[2490,2490]]],[1552830726163,["79054@DESKTOP-05FPSNP",[[1,3408,"## "]],[3408,3408],[3411,3411]]],[1552830732550,["79054@DESKTOP-05FPSNP",[[1,6298,"## "]],[6298,6298],[6301,6301]]],[1552830733647,["79054@DESKTOP-05FPSNP",[[1,6310,"## "]],[6310,6310],[6313,6313]]],[1552830736644,["79054@DESKTOP-05FPSNP",[[1,7570,"## "]],[7570,7570],[7573,7573]]],[1552830738422,["79054@DESKTOP-05FPSNP",[[1,7752,"## "]],[7752,7752],[7755,7755]]],[1552830766281,["79054@DESKTOP-05FPSNP",[[-1,114,"："]],[115,115],[114,114]]]],null,"79054@DESKTOP-05FPSNP"],["01759254-03fe-4a8a-a086-363327fe8c79",1552900537964,"---\nlayout: post\ntitle: fbs改价策略\ndate: '2019-03-13 20:53'\ncategories: \n - 工作记录\ntags:\n - 自动改价程序\n---\n\n# 改价策略\n\n## 情况分析\n\n* 当**购物车价格**小于**当前定价**，**降价比**不超过**设定值**，设置价格为【**购物车价格**-**降价值**】\n* 当**购物车价格**小于**当前定价**，**降价比**超过**设定值**，不改价\n* 当**购物车价格**等于**当前定价**，不改价\n* 当**购物车价格**大于**当前定价**，不改价\n\n# 改价程序流程\n\n## 启动chrome浏览器\n\n```python\nchrome=webdriver.Chrome(executable_path=chromePath, chrome_options=option)\n```\n\n## 打开卖家登录界面[seller-login](https://uae.souq.com/ae-en/account.php)\n\n```python\n# 获取email 和 password 控件\n    print(\"登录账户\")\n    chrome.get(loginUri)\n    try:\n        elemNewAccount = chrome.find_element_by_id(\"email\")\n        elemNewLoginBtn = chrome.find_element_by_id(\"siteLogin\")\n        elemNewAccount.send_keys(account)\n        print(\"输入账户:\" + account)\n        elemNewLoginBtn.click()\n        print(\"点击siteLogin\")\n        try:\n            cssSelectText = \"#continue\"\n            WebDriverWait(chrome, 10, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n            print(\"获取到continue按钮\")\n            elemContinue = chrome.find_element_by_id(\"continue\")\n            elemContinue.click()\n            print(\"点击continue\")\n            cssSelectText = \"#ap_password\"\n            WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n            print(\"获取到password输入框\")\n            elemPassword = chrome.find_element_by_id(\"ap_password\")\n            elemLoginBtn = chrome.find_element_by_id(\"signInSubmit\")\n            elemPassword.send_keys(Keys.CONTROL + \"a\")\n            elemPassword.send_keys(password)\n            print(\"输入密码：********\")\n            elemLoginBtn.click()\n            print(\"点击continue\")\n        except:\n            print(\"方式一登录失败，尝试方式二登录\")\n            cssSelectText = \"#password\"\n            WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n            print(\"获取到password输入框\")\n            elemPassword = chrome.find_element_by_id(\"password\")\n            elemLoginBtn = chrome.find_element_by_id(\"siteLogin\")\n            elemPassword.clear()\n            elemPassword.send_keys(password)\n            print(\"输入密码：********\")\n            elemLoginBtn.click()\n            print(\"点击登录\")\n\n        cssSelectText = \"#search_box\"\n        WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.CSS_SELECTOR, cssSelectText)))\n    except:\n        if str(chrome.current_url).find(\"uae.souq.com/ae-en/account.php\") < 0:\n            raise\n```\n\n## 登入成功后打开[fbs-inventory](https://sell.souq.com/fbs-inventory)\n\n```python\nloginHandler = chrome.current_window_handle\n    handlers = chrome.window_handles\n    unknownHandler = \"\"\n    for handler in handlers:\n        if handler != loginHandler:\n            unknownHandler = handler\n            break\n    readyUri = \"https://sell.souq.com/fbs-inventory\"\n    js = 'window.open(\"' + readyUri + '\")'\n    chrome.execute_script(js)\n    handlers = chrome.window_handles\n    for handler in handlers:\n        if handler != loginHandler and handler != unknownHandler:\n            inventoryHandler = handler\n            break\n    print(\"跳转到改价界面\")\n    while 1:\n        try:\n            chrome.switch_to_window(inventoryHandler)\n            print(\"开始循环处理\")\n            OperateProduct(chrome, record, attention, percent, lowwer)\n        except:\n            print(\"循环改价发生错误，马上重新开始\")\n        print(\"刷新改价界面\")\n        chrome.refresh()\n```\n\n## 开始循环改价\n\n* 获取商品列表的第一行 **first_row**\n\n```python\n first_row = chrome.find_elements_by_css_selector('//*[@id=\"table-inventory\"]/tbody/tr[1]')\n```\n\n* 点击第一行\n\n```python\nchrome.execute_script(\"arguments[0].click()\", first_row)\n```\n\n* 循环改价操作\n   ![chagePriceOperate]({{site.url | append: site.baseurl}}/styles/images/chagePriceOperate.png)\n\n```python\n    i = 0\n    while 1:\n        WebDriverWait(chrome, 60, 0.5).until(checkPage)\n        gold_price = 0\n\n        # 获取EAN\n        ean_elem = chrome.find_element_by_xpath('//*[@id=\"offerListitng\"]/div[2]/div/div[1]/div[1]/span')\n        ean = ean_elem.text.split(\";\")[-1]\n        timestr = time.strftime(\"%Y-%m-%d %H:%M:%S\")\n\n        # 获取当前价格输入框，并获取当前价格\n        self_price_elem = chrome.find_element_by_xpath(\n            '//*[@id=\"offerListitng\"]/div[4]/div[2]/div/div/div/div[1]/sc-offer-listing/div/div[1]/label[2]/input')\n        self_price = float(self_price_elem.get_attribute(\"value\"))\n\n        # 获取购物车价格\n        try:\n            gold_price_elem = chrome.find_element_by_xpath('//*[@id=\"offerListitng\"]/div[4]/div[2]/div/div/div/div[1]/sc-offer-listing/div/div[1]/label[2]/small[1]/span[2]')\n            gold_price = float(re.findall(r\"\\d+\\.?\\d*\", gold_price_elem.text)[0])\n        except NoSuchElementException:\n            i += 1\n            out = str(i) + \"-->\" + timestr + \" \" + ean + \"\\t只有本店铺一家卖此产品\"\n            print(out)\n        out = timestr + \" \" + ean + \"\\t购物车：\" + str(gold_price) + \"\\t本店铺：\" + str(self_price) + \"\\t降价比:\" + str(\n            round((self_price - gold_price) / self_price, 2) * 100) + \"%\"\n\n        # 判断\n        # if 购物车价格 小于 当前定价 and 降价比 不超过 设定值:\n        if gold_price < self_price and ((self_price-gold_price)/self_price) <= percent:\n            # 修改当前价格输入框的中价格为【购物车价格-降价值】\n            to_price = round(gold_price - lowwer, 2)\n            self_price_elem.send_keys(Keys.CONTROL + \"a\")\n            self_price_elem.send_keys(str(to_price))\n            # 获取按钮【更新】，并点击\n            update_elem = chrome.find_element_by_xpath('//*[@id=\"offerListitng\"]/div[3]/div/div/input')\n            chrome.execute_script(\"arguments[0].click()\", update_elem)\n            out += \"\\t修改价格：\" + str(to_price) + \"\\n\"\n            record.write(out)\n            record.flush()\n        else:\n            out += \"\\t不处理\\n\"\n            attention.write(out)\n            attention.flush()\n        out = out[0:-1]\n        i += 1\n        out = str(i) + \"-->\" + out\n        print(out)\n        # 获取按钮【下一个】，并点击\n        path = '//*[@id=\"offerListitng\"]/div[3]/div/div/div/div/div/a[2]'\n        WebDriverWait(chrome, 20, 0.5).until(EC.presence_of_element_located((By.XPATH, path)))\n        next_elem = chrome.find_element_by_xpath(path)\n        if next_elem.get_attribute(\"class\") == \"button-disabled\":\n            print(\"完成一次循环\")\n            raise IndexError\n        chrome.execute_script(\"arguments[0].click()\", next_elem)\n        time.sleep(0.5)\n```\n\n# 总结\n\n## xpath的使用\n## 判断网页已全部加载完成\n\n```python\ndef checkPage(driver):\n    checkPageFinishScript = \"try {if (document.readyState !== 'complete') {return false;} if (window.jQuery) { if (\" \\\n                            \"window.jQuery.active) { return false; } else if (window.jQuery.ajax && \" \\\n                            \"window.jQuery.ajax.active) { return false; } } if (window.angular) { if (!window.qa) { \" \\\n                            \"window.qa = {doneRendering: false }; } var injector = window.angular.element(\" \\\n                            \"'body').injector(); var $rootScope = injector.get('$rootScope'); var $http = \" \\\n                            \"injector.get('$http'); var $timeout = injector.get('$timeout'); if ($rootScope.$$phase \" \\\n                            \"=== '$apply' || $rootScope.$$phase === '$digest' || $http.pendingRequests.length !== 0) \" \\\n                            \"{ window.qa.doneRendering = false; return false; } if (!window.qa.doneRendering) { \" \\\n                            \"$timeout(function() { window.qa.doneRendering = true;}, 0); return false;}} return \" \\\n                            \"true;} catch (ex) {return false;} \"\n    return driver.execute_script(checkPageFinishScript)\n\nWebDriverWait(chrome, 60, 0.5).until(checkPage)\n```\n\n## 请空**INPUT框**的内容\n\n```python\n# 方法一：使用clear清空\ninput_elem.clear()\ninput_elem.send_keys(\"content\")\n# 方法二:\ninput_elem.send_keys(Keys.CONTROL + \"a\")\ninput_elem.send_keys(\"content\")\n```\n\n## python+selenium开发基本过程\n",[[1552900533776,["79054@DESKTOP-05FPSNP",[[1,3703,"a"],[-1,3704,"tyle"]],[3703,3703],[3706,3706]]],[1552900535380,["79054@DESKTOP-05FPSNP",[[1,3706,"ets"]],[3706,3706],[3709,3709]]],[1552900538557,["79054@DESKTOP-05FPSNP",[[-1,3711,"mages"]],[3710,3716],[3711,3711]]],[1552900538862,["79054@DESKTOP-05FPSNP",[[1,3711,"mg"]],[3711,3711],[3713,3713]]],[1552918454691,["79054@DESKTOP-05FPSNP",[[1,282,"#"],[1,291,"#"],[1,397,"#"],[1,2488,"#"],[1,3407,"#"]],[3718,3718],[281,281]]],[1552918457284,["79054@DESKTOP-05FPSNP",[[-1,282,"#"],[-1,292,"#"],[-1,399,"#"],[-1,2491,"#"],[-1,3411,"#"]],[281,281],[3718,3718]]]],null,"79054@DESKTOP-05FPSNP"]]}